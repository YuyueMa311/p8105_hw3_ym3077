---
title: "p8105_hw3_ym3077"
output: github_document
---

Load packages
```{r}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(patchwork)
```

## Problem 1

```{r}
library(p8105.datasets)
data("instacart")

instacart_summary = list(instacart)
head(instacart,10)
```
This `instacart` dataset has `r nrow(instacart)` observations for 131,209 users and `r ncol(instacart)` variables/rows, where each row represents a product from a single order and is associated with a customer.    
The 15 variables in this dataset are: `order_id` (order identifier), `product_id` (product identifier), `add_to_cart_order` (order of each product was added to cart), `reordered` (1 if ordered before, 0 otherwise), `user_id` (customer identifier), `eval_set` (which evaluation this order belongs to), `order_number` (the order number for this user, 1=first, n=nth), `order_dow` (the day of the week when this order was placed), `order_hour_of_day` (the hour of the day when this order was placed), `days_since_prior_order` (days since the last order, capped at 30, NA if order_number=1), `product_name` (name of the product), `aisle_id`(aisle identifier), `department_id` (department identifier), `aisle` (the name of the aisle), `department` (department this product belongs to).

```{r}
n_aisles = instacart |>
  distinct(aisle) |>
  nrow()

aisle_summary = instacart |>
  group_by(aisle) |>
  summarize(n_orders = n()) |>
  arrange(desc(n_orders))

n_aisles
aisle_summary
```
There are 134 aisles on the dataset, and fresh vegetables is the aisle with the most items ordered from.


Plot the number of items ordered in each aisle (>10000 orders)
```{r}
aisle_plot = instacart |>
  group_by(aisle) |>
  summarize(n_orders = n()) |>
  filter(n_orders > 10000) |>
  mutate(aisle = fct_reorder(aisle, n_orders)) 

ggplot(aisle_plot, aes(x = aisle, y = n_orders)) + 
  geom_col(fill = "purple") +
  labs(
    title = "Items ordered by aisle (> 10000 orders)",
    x = "Aisle",
    y = "Number of items ordered") +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

Table with three most popular items in “baking ingredients”, “dog food care”, and “packaged vegetables fruits”
```{r}
pop_items = instacart |>
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |>
  group_by(aisle, product_name) |>
  summarize(n_orders = n()) |>
  arrange(aisle, desc(n_orders)) |>
  slice_head(n=3)

pop_items
```

Table with mean hour of the day that Pink Lady Apples and Coffee Ice Cream were ordered on each day of the weak
```{r}
meanhour_table = instacart |>
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |>
  group_by(product_name, order_dow) |>
  summarize(
    mean_hour = mean(order_hour_of_day, na.rm = TRUE)) |>
  pivot_wider(
    names_from = order_dow,
    values_from = mean_hour) |>
  knitr::kable(digits = 1)

meanhour_table
```


## Problem 2

Import, clean, and otherwise tidy these datasets.
```{r}
zillow <- read_csv("data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |> 
 janitor::clean_names()

zipcode <- read_csv("data/Zip Codes.csv") |> 
 janitor::clean_names()

zillow_clean <- zillow |> 
  pivot_longer(
    cols = starts_with("x"),
    names_to = "date",
    values_to = "zori"
  ) |>
  mutate(
    date = str_remove(date, "^x"),    
    date = ymd(date),               
    year = year(date),
    month = month(date, label = TRUE, abbr = FALSE),
    zip = as.character(region_name)
  )

zipcode_clean <- zipcode |> 
  select(zip_code, borough = county, neighborhood) |> 
  rename(zip = zip_code) |> 
  mutate(zip = as.character(zip))

zillow_merged <- left_join(zillow_clean, zipcode_clean, by = "zip", relationship = "many-to-many")

zillow_merged <- zillow_merged |>
  select(-state_name) |>
  select(zip, region_id, region_name, region_type, state, city, county_name, borough,
         neighborhood, year, month, date, zori, everything()) |>
  arrange(zip, year, match(month, month.name))

zillow_merged
```

There are 116 months between January 2015 and August 2024. How many ZIP codes are observed 116 times? How many are observed fewer than 10 times? Why are some ZIP codes are observed rarely and others observed in each month?
```{r}
zip_summary <- zillow_merged |>
  filter(!is.na(zori)) |>
  group_by(zip) |>
  summarize(n_months = n_distinct(date))

zip_116 <- zip_summary |>
  summarize(n = sum(n_months == 116))
zip_116

zip_10 <-zip_summary |>
  summarize(n = sum(n_months < 10))
zip_10
```
There are 48 ZIP codes are observed 116 times, and 26 ZIP codes are observed fewer than 10 times. ZIP codes observed in each month might locate at highly populated residential areas (ie. Manhattan) with frequently updated rental markets information; while others are observed rarely might locate at low residential activity area (ie. few rental listings, industrial or commercial zones).


Create a reader-friendly table showing the average rental price in each borough and year (not month). Comment on trends in this table.
```{r}
borough_yr <- zillow_merged |>
  filter(!is.na(zori)) |>
  group_by(borough, year) |>
  summarize(
    mean_zori = mean(zori)) |>
  pivot_wider(
    names_from = year,
    values_from = mean_zori)

borough_yr
```
Manhattan (New York County) has the highest price every year with a wide margin. There’s a huge decrease during 2020–2021 followed by a sharp rebound and new highs by 2023–2024.   
Brooklyn (Kings) and Queens sit in the middle tier with steady increases through 2024. 
The Bronx is consistently the lowest-price borough, but it still shows a clear upward trend over the decade. 
Richmond (Staten Island) has missing early years, but from 2020 to 2024, it shows a steady increase, consistent with post-pandemic recovery. 
Overall trend across boroughs is slight growth pre-COVID, a decrease in 2020–2021, and strong acceleration by 2022–2024, with Manhattan leading and Bronx lowest throughout.


Make a plot showing NYC Rental Prices within ZIP codes for all available years. Your plot should facilitate comparisons across boroughs. Comment on any significant elements of this plot.
```{r}
zip_trend = zillow_merged |>
  filter(!is.na(zori)) |>
  mutate(year = as.integer(year)) |>
  select(borough, zip, year, zori)

ggplot(zip_trend, aes(x = year, y = zori, color = borough)) +
  geom_point(aes(group = zip), alpha = 0.4, size = 0.3) +
  geom_smooth(se = FALSE, method = "loess", na.rm = TRUE, size = 1.2) +
  labs(
    title = "NYC Rental Prices within ZIP across boroughs, 2015–2024",
    subtitle = "Faint dots = ZIP-level ZORI data & Bold lines = Borough-level trends",
    x = "Year", y = "Rental Prices (ZORI-Rent Index)", color = "Borough") +
  scale_x_continuous(breaks = 2015:2024) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5),
    axis.title = element_text(size = 10))
```
This plot shows the steadily increasing trend across all boroughs from 2015 to 2024 with a noticeable acceleration starting 2021, likely reflecting the post-pandemic recovery on rental prices and rising housing demand. Another significant element is a clear gap between boroughs gets wider over time, reflecting unequal growth in rental markets across the city. Last, but not the least, New York (Manhattan) consistently has the highest rental prices, followed by Kings (Brooklyn), Queens, and then Richomond (Staten Island) and Bronx. 


Compute the average rental price within each ZIP code over each month in 2023. Make a reader-friendly plot showing the distribution of ZIP-code-level rental prices across boroughs; put differently, your plot should facilitate the comparison of the distribution of average rental prices across boroughs. Comment on this plot
```{r}
zip_2023 <- zillow_merged |>
  filter(!is.na(zori), year(date) == 2023) |>
  mutate(month = month(date)) |>
  group_by(borough, zip, month) |>
  summarize(avg_zori = mean(zori, na.rm = TRUE)) |>
  mutate(borough = fct_reorder(borough, avg_zori))

ggplot(zip_2023, aes(x = borough, y = avg_zori, fill = borough)) +
  geom_violin(alpha = 0.5) +
  stat_summary(fun = "median", color = "blue") +
  labs(
    title = "Distribution of ZIP-level Monthly Average Rents (ZORI) by Borough, 2023",
    x = "Borough",
    y = "Monthly Average ZORI (per ZIP)" ) +
  theme_minimal(base_size = 10) +
  theme(legend.position = "bottom")
```
This violin plot shows the distribution of ZIP-level average monthly rental prices (ZORI) across NYC 5 boroughs in 2023. New York(Manhattan) shows the highest rental prices with widest spread, reflecting large variation across zip codes. Kings(Brooklyn) ranks second with a moderately wide distribution, suggesting small but noticeable variability within the borough. Queens and Bronx have lower median rent prices, around 2250 with comparatively tighter spreads. Richmond (Staten Island) has the lowest and uniform rent distribution, reflecting more consistent housing rental prices within the borough.


Combine the two previous plots into a single graphic, and export this to a results folder in your repository.
```{r}
zip_trend_plot = zillow_merged |>
  filter(!is.na(zori)) |>
  mutate(year = as.integer(year)) |>
  select(borough, zip, year, zori) |>
  ggplot(aes(x = year, y = zori, color = borough)) +  
  geom_point(aes(group = zip), alpha = 0.4, size = 0.3) +
  geom_smooth(se = FALSE, method = "loess", na.rm = TRUE, size = 1.2) +
  labs(
    title = "NYC Rental Prices within ZIP across boroughs, 2015–2024",
    subtitle = "Faint dots = ZIP-level ZORI data & Bold lines = Borough-level trends",
    x = "Year", 
    y = "Rental Prices (ZORI–Rent Index)",
    color = "Borough"
  ) +
  scale_x_continuous(breaks = 2015:2024) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5),
    axis.title = element_text(size = 10)
  )

zip_2023_plot = zillow_merged |>
  filter(!is.na(zori), year(date) == 2023) |>
  mutate(month = month(date)) |>
  group_by(borough, zip, month) |>
  summarize(avg_zori = mean(zori, na.rm = TRUE)) |>
  mutate(borough = fct_reorder(borough, avg_zori)) |>
  ggplot(aes(x = borough, y = avg_zori, fill = borough)) +
  geom_violin(alpha = 0.5) +
  stat_summary(fun = "median", color = "blue") +
  labs(
    title = "Distribution of ZIP-level Monthly Average Rents (ZORI) by Borough, 2023",
    x = "Borough",
    y = "Monthly Average ZORI (per ZIP)" ) +
  theme_minimal(base_size = 10) +
  theme(legend.position = "bottom")

combined_plot = zip_trend_plot / zip_2023_plot +
  plot_annotation(
    title = "NYC Zillow Rental Price Trends and 2023 Distribution",
    theme = theme(plot.title = element_text(face = "bold", size = 16))
  )
combined_plot

ggsave("results/nyc_rent_combined_plot.png", combined_plot, width = 10, height = 20, dpi = 300)
```


## Problem 3

Load, tidy, merge, and otherwise organize the data sets. Your final dataset should include all originally observed variables; exclude participants less than 21 years of age, and those with missing demographic data; and encode data with reasonable variable classes (i.e. not numeric, and using factors with the ordering of tables and plots in mind).
```{r}
nhanes_accel <- read_csv("data/nhanes_accel.csv") |> 
  janitor::clean_names()

nhanes_covar <- read_csv("data/nhanes_covar.csv", skip = 4) |> 
  janitor::clean_names()

covar_clean = nhanes_covar |> 
  filter(age >= 21) |>
  drop_na(sex, education, bmi, age) |> 
  mutate(
    sex = recode(sex, `1` = "male", `2` = "female"),
    education = recode(education, 
                       `1` = "Less than high school", 
                       `2` = "High school equivalent", 
                       `3` = "More than high school"),
    sex = factor(sex),
    education = factor(education, levels = c("Less than high school", "High school equivalent", "More than high school")),
    age = as.numeric(age),
    bmi = as.numeric(bmi))

nhanes_merged <- left_join(covar_clean, nhanes_accel, by = "seqn")
```


Produce a reader-friendly table for the number of men and women in each education category, and create a visualization of the age distributions for men and women in each education category. Comment on these items.
```{r}
edu_cat = nhanes_merged |>
  count(education, sex, name = "n") |>
  group_by(education) |>
  arrange(education, sex) |>
  pivot_wider(
    names_from = sex,
    values_from = n
  )
edu_cat

ggplot(nhanes_merged, aes(x = education, y = age, fill = sex)) +
  geom_boxplot(alpha = 0.5) +
  labs(
    title = "Age Distribution by Sex and Education Level",
    x = "Education Level",
    y = "Age" ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    legend.position = "bottom")
```
      
This boxplot shows that participants with lower education levels tend to be older, while those with higher education levels are generally younger. Overall, there’s no strong sex difference in age distribution, but education level appears inversely related to age in this dataset.


Traditional analyses of accelerometer data focus on the total activity over the day. Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant. Plot these total activities (y-axis) against age (x-axis); your plot should compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences. Comment on your plot.
```{r}
total_act = nhanes_merged |>
  group_by(seqn, sex, age, bmi, education) |>
  summarize(
            total_activity = sum(c_across(min1:min1440), na.rm = TRUE))

ggplot(total_act, aes(x = age, y = total_activity, color = sex)) + 
  geom_point(alpha = 0.5, size = 1) +
  geom_smooth(se = FALSE) +
  facet_grid(~education) +
  scale_y_continuous() +
  labs(
    title = "Total Activity (MIMS) VS. Age by Sex and Education Level",
    x = "Age",
    y = "Total MIMS Activity" ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    legend.position = "bottom")
```
  
This plot shows the total physical activity (MIMs) generally decrease as increasing age. Individual with higher education levels show slightly higher overall acticity compared with those with lower education level. Women tends to have higher total activity compared to man at "HS equivalent" and "More than HS" education level. 


Accelerometer data allows the inspection activity over the course of the day. Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. Describe in words any patterns or conclusions you can make based on this graph; including smooth trends may help identify differences.
```{r}
day_activity = nhanes_merged |>
  select(seqn, sex, education, starts_with("min")) |>
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",
    values_to = "mims") |>
  mutate(
    minute = as.integer(sub("min", "", minute)),
    hour = (minute - 1) / 60)

ggplot(day_activity, aes(x = hour, y = mims, color = sex)) + 
  geom_point(alpha = 0.2, size = 0.1) +
  geom_smooth(se = FALSE, size = 1.0) +
  facet_grid(~education) +
  scale_y_continuous() +
  labs(
    title = "24hrs Activity by Sex and Education Level",
    x = "Hour",
    y = "MIMS Activity")  +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    legend.position = "bottom")
```
     
This 24-hour activity plots shows a trend that activity levels are lowest during the night(0-6 hours, midnight till morning), and increase sharply in the morning from 8-10 hours (8-10AM), and remain relatively stable throughout the day and decrease gradualy in the evening from 20-23 (8-11PM). Across education level, individuals from "More than HS" have slightly higher activity patterns than those from lower education levels. The activity patterns between men and women are mainly similar. Overall, these trends suggest a consistent daytime activity patterns across groups, with minor variation by sex and education, which may reflect lifestyle differences.










